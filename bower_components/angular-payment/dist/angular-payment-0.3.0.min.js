angular.module("payment",["payment.service","payment.restrictNumeric","payment.cardCvc","payment.cardExpiry","payment.cardNumber"]),angular.module("payment.service",[]).factory("payment",["$document",function(a){"use strict";var b=/(\d{1,4})/g,c=[{type:"maestro",pattern:/^(5(018|0[23]|[68])|6(39|7))/,format:b,length:[12,13,14,15,16,17,18,19],cvcLength:[3],luhn:!0},{type:"dinersclub",pattern:/^(36|38|30[0-5])/,format:b,length:[14],cvcLength:[3],luhn:!0},{type:"laser",pattern:/^(6706|6771|6709)/,format:b,length:[16,17,18,19],cvcLength:[3],luhn:!0},{type:"jcb",pattern:/^35/,format:b,length:[16],cvcLength:[3],luhn:!0},{type:"unionpay",pattern:/^62/,format:b,length:[16,17,18,19],cvcLength:[3],luhn:!1},{type:"discover",pattern:/^(6011|65|64[4-9]|622)/,format:b,length:[16],cvcLength:[3],luhn:!0},{type:"mastercard",pattern:/^5[1-5]/,format:b,length:[16],cvcLength:[3],luhn:!0},{type:"amex",pattern:/^3[47]/,format:/(\d{1,4})(\d{1,6})?(\d{1,5})?/,length:[15],cvcLength:[3,4],luhn:!0},{type:"visa",pattern:/^4/,format:b,length:[13,14,15,16],cvcLength:[3],luhn:!0},{type:"visaelectron",pattern:/^4(026|17500|405|508|844|91[37])/,format:b,length:[16],cvcLength:[3],luhn:!0},{type:"forbrugsforeningen",pattern:/^600/,format:b,length:[16],cvcLength:[3],luhn:!0},{type:"dankort",pattern:/^5019/,format:b,length:[16],cvcLength:[3],luhn:!0}],d=function(a){return a.toString().replace(/^\s+|\s+$/g,"")},e=function(b){var c;return null!=b.prop("selectionStart")&&b.prop("selectionStart")!==b.prop("selectionEnd")?!0:void 0!==a&&null!==a&&null!=(c=a.selection)&&"function"==typeof c.createRange?c.createRange().text:void 0},f=function(a){var b,d,e;if(!a)return null;for(a=a.toString().replace(/\D/g,""),d=0,e=c.length;e>d;d++)if(b=c[d],b.pattern.test(a))return b;return null},g=function(a){var b,c,d=a.toString().split("").reverse(),e=0,f=!0;for(c=0;c<d.length;c++)b=d[c],b=parseInt(b,10),(f=!f)&&(b*=2),b>9&&(b-=9),e+=b;return e%10===0},h=function(a){if(!a)return!1;var b;return a=a.toString().replace(/\s+|-/g,""),/^\d+$/.test(a)?(b=f(a),b?b.length.indexOf(a.length)>=0&&(b.luhn===!1||g(a)):!1):!1},i=function(a){var b,c,d,e,g=f(a);return g?(c=g.length[g.length.length-1],a=a.replace(/\D/g,""),a=a.slice(0,+c+1||9e9),g.format.global?e=null!==(d=a.match(g.format))?d.join(" "):void 0:(b=g.format.exec(a),null!==b&&b.shift(),e=null!==b?b.join(" "):void 0),e):a},j=function(a,b){var c,e,f;return"object"==typeof a&&a.hasOwnProperty("month")&&(b=a.year,a=a.month),a&&b?(a=d(a),b=d(b),/^\d+$/.test(a)&&/^\d+$/.test(b)&&parseInt(a,10)<=12?(2===b.length&&(f=(new Date).getFullYear(),f=f.toString().slice(0,2),b=f+b),e=new Date(b,a),c=new Date,e.setMonth(e.getMonth()-1),e.setMonth(e.getMonth()+1,1),e>c):!1):!1},k=function(a){var b;for(b=0;b<c.length;b++)if(c[b].type===a)return c[b];return void 0},l=function(a,b){var c;return a=d(a),/^\d+$/.test(a)?b?(c=k(b),c?c.cvcLength.indexOf(a.length)>=0:!1):a.length>=3&&a.length<=4:!1};return{hasTextSelected:e,cardFromNumber:f,validateCardNumber:h,validateCardExpiry:j,validateCardCvc:l,formatCardNumber:i}}]),angular.module("payment.restrictNumeric",[]).directive("restrictNumeric",function(){"use strict";var a=function(a){a.metaKey||a.ctrlKey||0===a.which||a.which<33||(32===a.which||!!/[\d\s]/.test(String.fromCharCode(a.which))==!1)&&a.preventDefault()};return{restrict:"A",link:function(b,c){c.bind("keypress",a)}}}),angular.module("payment.cardCvc",["payment.service","payment.restrictNumeric"]).directive("cardCvcInput",function(){"use strict";return{restrict:"E",templateUrl:"template/cardCvc/cardCvc.html",replace:!0}}).directive("cardCvcFormatter",function(){"use strict";var a=function(a){var b,c,d=angular.element(a.currentTarget);b=String.fromCharCode(a.which),/^\d+$/.test(b)&&(c=d.val()+b,c.length>4&&a.preventDefault())};return{link:function(b,c){c.bind("keypress",a)}}}).directive("cardCvcValidator",["payment",function(a){"use strict";return{require:"ngModel",link:function(b,c,d,e){function f(b){var c=b?a.validateCardCvc(b):!1;return e.$setValidity("cardCvc",c),c}e.$parsers.unshift(function(a){return f(a)?a:void 0}),e.$formatters.unshift(function(a){f(a)})}}}]),angular.module("payment.cardExpiry",["payment.service","payment.restrictNumeric"]).directive("cardExpiryInput",["payment",function(){"use strict";return{restrict:"E",templateUrl:"template/cardExpiry/cardExpiry.html",replace:!0}}]).directive("cardExpiryFormatter",["payment",function(a){"use strict";var b=function(a){var b,c,d;c=String.fromCharCode(a.which),/^\d+$/.test(c)&&(b=angular.element(a.currentTarget),d=b.val()+c,/^\d$/.test(d)&&"0"!==d&&"1"!==d?(a.preventDefault(),b.val("0"+d+" / ")):/^\d\d$/.test(d)&&(a.preventDefault(),b.val(d+" / ")))},c=function(a){var b,c,d;c=String.fromCharCode(a.which),/^\d+$/.test(c)&&(b=angular.element(a.currentTarget),d=b.val(),/^\d\d$/.test(d)&&b.val(d+" / "))},d=function(a){var b,c,d;c=String.fromCharCode(a.which),"/"===c&&(b=angular.element(a.currentTarget),d=b.val(),/^\d$/.test(d)&&"0"!==d&&b.val(d+" / "))},e=function(a){var b,c;a.meta||(b=angular.element(a.currentTarget),c=b.val(),8===a.which&&(null==b.prop("selectionStart")||b.prop("selectionStart")===c.length)&&(/\d(\s|\/)+$/.test(c)?(a.preventDefault(),b.val(c.replace(/\d(\s|\/)*$/,""))):/\s\/\s?\d?$/.test(c)&&(a.preventDefault(),b.val(c.replace(/\s\/\s?\d?$/,"")))))},f=function(b){var c,d,e=angular.element(b.currentTarget);c=String.fromCharCode(b.which),/^\d+$/.test(c)&&(a.hasTextSelected(e)||(d=e.val()+c,d=d.replace(/\D/g,""),d.length>6&&b.preventDefault()))};return{link:function(a,g){g.bind("keypress",f),g.bind("keypress",b),g.bind("keypress",d),g.bind("keypress",c),g.bind("keydown",e)}}}]).directive("cardExpiryValidator",["payment",function(a){"use strict";var b=function(a){var b,c,d,e;return a=a.replace(/\s/g,""),e=a.split("/",2),b=e[0],d=e[1],2===(d?d.length:void 0)&&/^\d+$/.test(d)&&(c=(new Date).getFullYear(),c=c.toString().slice(0,2),d=c+d),b=parseInt(b,10),d=parseInt(d,10),{month:b,year:d}};return{require:"ngModel",link:function(c,d,e,f){f.$parsers.unshift(function(c){var d=b(c),e=a.validateCardExpiry(d.month,d.year);return f.$setValidity("cardExpiry",e),e?d:void 0}),f.$formatters.unshift(function(b){var c=b&&b.hasOwnProperty("month")&&b.hasOwnProperty("year")?a.validateCardExpiry(b.month,b.year):!1;return f.$setValidity("cardExpiry",c),c?b.month+" / "+b.year:void 0})}}}]),angular.module("payment.cardNumber",["payment.service","payment.restrictNumeric"]).directive("cardNumberInput",function(){"use strict";return{restrict:"E",templateUrl:"template/cardNumber/cardNumber.html",replace:!0}}).directive("cardNumberFormatter",["$timeout","$parse","payment",function(a,b,c){"use strict";var d=function(a){var b,d,e=String.fromCharCode(a.which),f=angular.element(a.currentTarget);/^\d+$/.test(e)&&(c.hasTextSelected(f)||(d=(f.val()+e).replace(/\D/g,""),b=c.cardFromNumber(d),b&&d.length>b.length[b.length.length-1]?a.preventDefault():d.length>16&&a.preventDefault()))},e=function(a){var b,d,e,f,g,h,i=16;e=String.fromCharCode(a.which),/^\d+$/.test(e)&&(b=angular.element(a.currentTarget),h=b.val(),d=c.cardFromNumber(h+e),f=(h.replace(/\D/g,"")+e).length,d&&(i=d.length[d.length.length-1]),f>=i||(null===b.prop("selectionStart")||b.prop("selectionStart")===h.length)&&(g=d&&"amex"===d.type?/^(\d{4}|\d{4}\s\d{6})$/:/(?:^|\s)(\d{4})$/,g.test(h)?(a.preventDefault(),b.val(h+" "+e)):g.test(h+e)&&(a.preventDefault(),b.val(h+e+" "))))},f=function(b){var d=angular.element(b.currentTarget);a(function(){var a=d.val();a=c.formatCardNumber(a),d.val(a)})};return{require:"ngModel",link:function(a,g,h,i){function j(b){if(h.cardType){var d=c.cardFromNumber(b);k.assign(a,d&&k!==d.type?d.type:null)}}var k=b(h.cardType);g.bind("keypress",d),g.bind("keypress",e),g.bind("paste",f),i.$formatters.unshift(function(a){return j(a),c.formatCardNumber(a)}),i.$parsers.unshift(function(a){return j(a),a})}}}]).directive("cardNumberValidator",["payment",function(a){"use strict";return{require:"ngModel",link:function(b,c,d,e){function f(b){if(!b)return!1;var c=a.validateCardNumber(b);return e.$setValidity("cardNumber",c),c}e.$parsers.push(function(a){return f(a)?a.replace(/ /g,""):void 0}),e.$formatters.unshift(function(a){return f(a),a})}}}]);